<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>가위바위보 도박장</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
    header { background: #16213e; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3460; }
    header h1 { font-size: 1.3rem; color: #e94560; }
    header .info { display: flex; align-items: center; gap: 16px; font-size: 0.9rem; }
    header .coins { color: #f0a500; font-weight: bold; }
    header button { background: #e94560; border: none; color: #fff; padding: 6px 14px; border-radius: 4px; cursor: pointer; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    #auth-section { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
    .auth-box { background: #16213e; padding: 32px; border-radius: 8px; width: 320px; }
    .auth-box h2 { margin-bottom: 20px; color: #e94560; text-align: center; }
    .auth-box input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #0f3460; border-radius: 4px; background: #1a1a2e; color: #eee; }
    .auth-box button { width: 100%; padding: 10px; background: #e94560; border: none; color: #fff; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .auth-box button:hover { background: #c73550; }
    .auth-box .toggle { text-align: center; margin-top: 12px; color: #aaa; font-size: 0.85rem; }
    .auth-box .toggle a { color: #e94560; cursor: pointer; text-decoration: underline; }
    #game-section { display: none; }
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
    .tabs button { flex: 1; padding: 10px; background: #16213e; border: 2px solid #0f3460; color: #aaa; border-radius: 6px 6px 0 0; cursor: pointer; }
    .tabs button.active { background: #0f3460; color: #e94560; border-color: #e94560; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: #16213e; border: 1px solid #0f3460; border-radius: 8px; padding: 20px; margin-bottom: 16px; text-align: center; }
    .card h3 { color: #e94560; margin-bottom: 12px; }
    .choices { display: flex; gap: 12px; justify-content: center; margin-bottom: 16px; }
    .choices button { width: 80px; height: 80px; font-size: 2rem; border: 3px solid #0f3460; border-radius: 12px; background: #1a1a2e; cursor: pointer; transition: all 0.2s; }
    .choices button:hover { border-color: #e94560; transform: scale(1.1); }
    .choices button.selected { border-color: #e94560; background: #0f3460; }
    .bet-row { display: flex; gap: 8px; justify-content: center; align-items: center; margin-bottom: 16px; }
    .bet-row input { width: 120px; padding: 8px; background: #1a1a2e; border: 1px solid #0f3460; border-radius: 4px; color: #f0a500; text-align: center; font-size: 1.1rem; }
    .bet-row span { color: #aaa; }
    .btn-play { padding: 12px 40px; background: #e94560; border: none; color: #fff; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
    .btn-play:hover { background: #c73550; }
    .btn-play:disabled { background: #555; cursor: not-allowed; }
    .result-box { background: #0d0d1a; border: 1px solid #0f3460; border-radius: 8px; padding: 20px; margin-top: 16px; text-align: center; display: none; }
    .result-box .emoji { font-size: 3rem; }
    .result-box .msg { font-size: 1.2rem; margin: 8px 0; }
    .result-box .win { color: #4ecca3; }
    .result-box .lose { color: #e94560; }
    .result-box .draw { color: #f0a500; }
    .history { max-height: 300px; overflow-y: auto; }
    .history-item { display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #0f3460; font-size: 0.85rem; }
    .history-item .win { color: #4ecca3; }
    .history-item .lose { color: #e94560; }
    .history-item .draw { color: #f0a500; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #0f3460; font-size: 0.9rem; }
    th { background: #0f3460; color: #e94560; }
    tr:hover { background: #1e2a4a; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 6px; font-size: 0.9rem; z-index: 999; animation: fadeIn 0.3s; }
    .toast.error { background: #e94560; color: #fff; }
    .toast.success { background: #4ecca3; color: #1a1a2e; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; } }
    .empty { text-align: center; color: #555; padding: 30px; }
    .streak { color: #f0a500; font-size: 0.85rem; margin-top: 4px; }
  </style>
</head>
<body>

<div id="auth-section">
  <div class="auth-box">
    <h2 id="auth-title">로그인</h2>
    <input type="text" id="auth-username" placeholder="아이디">
    <input type="password" id="auth-password" placeholder="비밀번호">
    <button onclick="handleAuth()" id="auth-btn">로그인</button>
    <div class="toggle">
      <span id="auth-toggle-text">계정이 없으신가요?</span>
      <a onclick="toggleAuth()" id="auth-toggle-link">회원가입</a>
    </div>
  </div>
</div>

<div id="game-section">
  <header>
    <h1>가위바위보 도박장</h1>
    <div class="info">
      <span id="display-user"></span>
      <span class="coins" id="display-coins"></span>
      <button onclick="logout()">로그아웃</button>
    </div>
  </header>
  <div class="container">
    <div class="tabs">
      <button class="active" onclick="switchTab('play')">게임</button>
      <button onclick="switchTab('history')">기록</button>
      <button onclick="switchTab('ranking')">랭킹</button>
    </div>

    <div id="tab-play" class="tab-content active">
      <div class="card">
        <h3>선택하세요</h3>
        <div class="choices">
          <button onclick="selectChoice(this,'가위')" id="btn-scissors">&#9996;</button>
          <button onclick="selectChoice(this,'바위')" id="btn-rock">&#9994;</button>
          <button onclick="selectChoice(this,'보')" id="btn-paper">&#9995;</button>
        </div>
        <div class="bet-row">
          <span>베팅:</span>
          <input type="number" id="bet-amount" value="100" min="1">
          <span>코인</span>
        </div>
        <button class="btn-play" onclick="play()" id="btn-play" disabled>승부!</button>
        <div class="streak" id="streak-display"></div>
      </div>
      <div class="result-box" id="result-box">
        <div class="emoji" id="result-emoji"></div>
        <div class="msg" id="result-msg"></div>
        <div id="result-detail"></div>
      </div>
    </div>

    <div id="tab-history" class="tab-content">
      <div class="history" id="history-list"></div>
    </div>

    <div id="tab-ranking" class="tab-content">
      <table>
        <thead><tr><th>#</th><th>이름</th><th>코인</th><th>승</th><th>패</th><th>승률</th></tr></thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
var API = '';
var token = localStorage.getItem('rps_token');
var username = localStorage.getItem('rps_username');
var isRegister = false;
var selectedChoice = null;
var CHOICE_EMOJI = { '가위': '\u2702\ufe0f', '바위': '\u270a', '보': '\u270b' };

async function api(method, path, body) {
  var opts = { method: method, headers: { 'Content-Type': 'application/json' } };
  if (token) opts.headers['Authorization'] = 'Bearer ' + token;
  if (body) opts.body = JSON.stringify(body);
  var res = await fetch(API + path, opts);
  var data = await res.json();
  if (!res.ok) throw new Error(data.error || '요청 실패');
  return data;
}

function toast(msg, type) {
  var el = document.createElement('div');
  el.className = 'toast ' + (type || 'success');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(function() { el.remove(); }, 3000);
}

function toggleAuth() {
  isRegister = !isRegister;
  document.getElementById('auth-title').textContent = isRegister ? '회원가입' : '로그인';
  document.getElementById('auth-btn').textContent = isRegister ? '가입하기' : '로그인';
  document.getElementById('auth-toggle-text').textContent = isRegister ? '이미 계정이 있으신가요?' : '계정이 없으신가요?';
  document.getElementById('auth-toggle-link').textContent = isRegister ? '로그인' : '회원가입';
}

async function handleAuth() {
  var u = document.getElementById('auth-username').value.trim();
  var p = document.getElementById('auth-password').value.trim();
  if (!u || !p) return toast('아이디와 비밀번호를 입력하세요', 'error');
  try {
    if (isRegister) {
      await api('POST', '/auth/register', { username: u, password: p });
      toast('가입 완료!');
    }
    var data = await api('POST', '/auth/login', { username: u, password: p });
    token = data.token; username = data.user.username;
    localStorage.setItem('rps_token', token);
    localStorage.setItem('rps_username', username);
    showGame();
  } catch (e) { toast(e.message, 'error'); }
}

function logout() {
  token = null; username = null;
  localStorage.removeItem('rps_token'); localStorage.removeItem('rps_username');
  document.getElementById('auth-section').style.display = 'flex';
  document.getElementById('game-section').style.display = 'none';
}

async function showGame() {
  document.getElementById('auth-section').style.display = 'none';
  document.getElementById('game-section').style.display = 'block';
  document.getElementById('display-user').textContent = username;
  await refreshMe();
}

async function refreshMe() {
  try {
    var data = await api('GET', '/users/me');
    document.getElementById('display-coins').textContent = data.coins + ' 코인';
    var streak = data.winStreak > 0 ? data.winStreak + '연승 중!' : '';
    document.getElementById('streak-display').textContent = streak;
  } catch (e) { /* ignore */ }
}

function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.remove('active'); });
  document.querySelectorAll('.tabs button').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('tab-' + name).classList.add('active');
  document.querySelector('.tabs button[onclick="switchTab(\'' + name + '\')"]').classList.add('active');
  if (name === 'history') loadHistory();
  if (name === 'ranking') loadRanking();
}

function selectChoice(btn, choice) {
  selectedChoice = choice;
  document.querySelectorAll('.choices button').forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
  document.getElementById('btn-play').disabled = false;
}

async function play() {
  if (!selectedChoice) return;
  var bet = parseInt(document.getElementById('bet-amount').value);
  try {
    var data = await api('POST', '/game/play', { choice: selectedChoice, bet: bet });
    var g = data.game;
    var box = document.getElementById('result-box');
    box.style.display = 'block';

    var emoji = document.getElementById('result-emoji');
    var msg = document.getElementById('result-msg');
    var detail = document.getElementById('result-detail');

    emoji.textContent = (CHOICE_EMOJI[g.choice] || '') + ' vs ' + (CHOICE_EMOJI[g.computerChoice] || '');

    if (g.result === 'win') {
      msg.className = 'msg win';
      msg.textContent = '승리! +' + g.coinsChange + ' 코인';
    } else if (g.result === 'lose') {
      msg.className = 'msg lose';
      msg.textContent = '패배! ' + g.coinsChange + ' 코인';
    } else {
      msg.className = 'msg draw';
      msg.textContent = '무승부!';
    }
    detail.textContent = '잔액: ' + g.coinsAfter + ' 코인';

    document.getElementById('display-coins').textContent = g.coinsAfter + ' 코인';
    await refreshMe();

    // 선택 초기화
    selectedChoice = null;
    document.querySelectorAll('.choices button').forEach(function(b) { b.classList.remove('selected'); });
    document.getElementById('btn-play').disabled = true;
  } catch (e) { toast(e.message, 'error'); }
}

async function loadHistory() {
  try {
    var data = await api('GET', '/game/history');
    var list = document.getElementById('history-list');
    list.textContent = '';
    if (!data.history || data.history.length === 0) {
      var empty = document.createElement('div'); empty.className = 'empty';
      empty.textContent = '게임 기록이 없습니다';
      list.appendChild(empty); return;
    }
    data.history.forEach(function(g) {
      var item = document.createElement('div'); item.className = 'history-item';
      var left = document.createElement('span');
      left.textContent = (CHOICE_EMOJI[g.choice]||g.choice) + ' vs ' + (CHOICE_EMOJI[g.computerChoice]||g.computerChoice);
      var right = document.createElement('span');
      right.className = g.result;
      if (g.result === 'win') right.textContent = '승리 +' + g.coinsChange;
      else if (g.result === 'lose') right.textContent = '패배 ' + g.coinsChange;
      else right.textContent = '무승부';
      item.appendChild(left); item.appendChild(right);
      list.appendChild(item);
    });
  } catch (e) { toast(e.message, 'error'); }
}

async function loadRanking() {
  try {
    var data = await api('GET', '/ranking');
    var tbody = document.getElementById('ranking-body');
    tbody.textContent = '';
    if (!data.ranking || data.ranking.length === 0) {
      var tr = document.createElement('tr'); var td = document.createElement('td');
      td.colSpan = 6; td.style.textAlign = 'center'; td.style.color = '#555';
      td.textContent = '데이터 없음'; tr.appendChild(td); tbody.appendChild(tr); return;
    }
    data.ranking.forEach(function(u, i) {
      var tr = document.createElement('tr');
      [i+1, u.username, u.coins, u.wins, u.losses, u.winRate+'%'].forEach(function(val) {
        var td = document.createElement('td'); td.textContent = val; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  } catch (e) { toast(e.message, 'error'); }
}

if (token && username) { showGame(); }
</script>
</body>
</html>
