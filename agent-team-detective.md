# 가위바위보 도박장 - 탐정 수사 에이전트 팀 시나리오

## 개요

의도적으로 8개의 버그가 숨겨진 가위바위보 도박장 서버를 에이전트 팀이 "탐정단"이 되어 수사하는 시나리오입니다.

## 사전 준비

```bash
cd rpg-api
npm install
node server.js
```

- 서버: `http://localhost:3000`
- 웹 UI: 브라우저에서 동일 주소 접속

---

## 프로젝트 구조

```
rpg-api/
├── server.js              # Express 서버 (회원가입/로그인)
├── public/index.html      # 게임 웹 UI
├── middleware/auth.js      # JWT 인증 (버그 1)
├── routes/
│   ├── users.js           # 유저 목록/검색 (버그 2, 3)
│   ├── game.js            # 가위바위보 게임 (버그 4, 5, 6)
│   └── ranking.js         # 랭킹 (버그 7)
├── data/store.js          # 인메모리 저장소
└── utils/helpers.js       # 유틸리티 (버그 8)
```

---

## 시나리오 프롬프트

아래 프롬프트를 Claude Code에 그대로 붙여넣으세요:

```
가위바위보 도박장 서버(rpg-api/)에서 심각한 이상 현상이 보고됐어.
유저들이 인증 없이 접속하고, 지는데 코인이 늘어나고, 비밀번호가 노출되는 사례가 속출해.
탐정 팀을 구성해서 모든 문제를 찾아내고 수사 보고서를 작성해줘.

에이전트 팀을 팀원 4명으로 만들어. 각 팀원은 Sonnet 모델을 사용해.

- 보안 전문가: 인증, 인젝션, 정보 노출 등 보안 취약점을 수사해
  - 담당 파일: middleware/auth.js, routes/users.js
  - 수사 전에 반드시 수사 계획을 제출해서 승인받아야 해

- 포렌식 분석가: 게임 로직 버그를 수사해 (코인 조작, 보너스 오류 등)
  - 담당 파일: routes/game.js
  - 수사 전에 반드시 수사 계획을 제출해서 승인받아야 해

- 성능 프로파일러: 성능 병목 지점을 수사해
  - 담당 파일: routes/ranking.js, utils/helpers.js
  - 수사 계획 승인 없이 자유롭게 수사 가능

- QA 수사관: 다른 팀원들이 발견한 버그를 재현하는 테스트 코드를 작성해
  - 담당 파일: tests/ 디렉토리
  - 다른 팀원들이 버그를 최소 3개 이상 발견한 후에 작업 시작해 (작업 종속성)

수사 규칙:
1. 나(수사반장)는 위임 모드로 운영해. 코드를 직접 보지 않고 조율만 할 거야.
2. 보안 전문가와 포렌식 분석가는 수사 계획 승인이 필요해.
3. 팀원들은 서로 직접 메시지를 보내서 발견한 단서를 공유해야 해.
4. 치명적인 취약점을 발견하면 broadcast로 전체 팀에 즉시 알려.
5. QA 수사관은 다른 팀원들의 발견을 기다린 후 테스트를 작성해.
6. 모든 수사가 끝나면 수사 보고서를 다음 형식으로 종합해줘:
   - 발견된 문제 목록 (심각도 순)
   - 각 문제의 영향 범위
   - 재현 방법
   - 권장 수정 방안

수사를 시작해. 먼저 작업 목록을 만들고 팀원들에게 할당해줘.
내가 위임 모드로 전환할 때까지 기다려.
```

---

## 체험할 에이전트 팀 기능

| Phase | 기능 | 설명 |
|-------|------|------|
| 1 | **TeamCreate** | 탐정 팀 생성 |
| 1 | **위임 모드 (Shift+Tab)** | 수사반장은 조율만 |
| 1 | **TaskCreate** | 수사 작업 생성 |
| 1 | **작업 종속성** | QA는 다른 팀원 발견에 의존 |
| 2 | **계획 승인** | 수사 계획 검토/승인 |
| 2 | **병렬 작업** | 보안/포렌식/성능 동시 수사 |
| 2 | **직접 메시지** | 팀원 간 단서 공유 |
| 3 | **broadcast** | 치명적 취약점 전체 알림 |
| 4 | **QA 테스트** | 버그 재현 테스트 작성 |
| 5 | **shutdown/TeamDelete** | 팀 해산 및 정리 |

---

## 숨겨진 버그 목록 (정답지)

<details>
<summary>정답 보기 (수사 완료 후 클릭)</summary>

### 보안 취약점

| # | 파일 | 버그 | 난이도 |
|---|------|------|--------|
| 1 | `middleware/auth.js` | Bearer 대소문자 비교로 인증 우회 (`bearer`→`jwt.decode` 서명 미검증) | ★★☆ |
| 2 | `routes/users.js` | `new RegExp(userInput)` → ReDoS 공격 가능 | ★★★ |
| 3 | `routes/users.js` | 유저 목록에 `password_hash` 노출 | ★☆☆ |

### 로직 버그

| # | 파일 | 버그 | 난이도 |
|---|------|------|--------|
| 4 | `routes/game.js` | 음수 베팅 미검증 → 지면 코인 증가 | ★★☆ |
| 5 | `routes/game.js` | 패배 페널티 = `bet - winStreak*10` → 연승 높으면 음수 → 지는데 코인 증가 | ★★★ |
| 6 | `routes/game.js` | 3연승 보너스 `> 3` 대신 `>= 3` 필요 (off-by-one) | ★☆☆ |

### 성능 이슈

| # | 파일 | 버그 | 난이도 |
|---|------|------|--------|
| 7 | `routes/ranking.js` | 매 요청마다 O(n*m) 중첩 루프, 캐싱 없음 | ★★☆ |
| 8 | `utils/helpers.js` | `fs.appendFileSync` 동기 I/O 블로킹 | ★☆☆ |

</details>

---

## API 엔드포인트

| 메서드 | 경로 | 설명 |
|---|---|---|
| POST | /auth/register | 회원가입 (1000코인 지급) |
| POST | /auth/login | 로그인 |
| GET | /users | 유저 목록 |
| GET | /users/search?name= | 유저 검색 |
| GET | /users/me | 내 정보 |
| POST | /game/play | 가위바위보 (choice + bet) |
| GET | /game/history | 게임 기록 |
| GET | /ranking | 랭킹 |
